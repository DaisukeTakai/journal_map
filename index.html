<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMed論文グラフ</title>
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <script src="dagre-d3.js"></script>
    <link rel="stylesheet" href="tipsy.css">
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="tipsy.js"></script>
</head>

<body>
    <h2>
        <input type="text" id="pmidInput" size="10" placeholder="PubMed ID" value="33627160">
        <button onclick="fetchPubMedData()">追加</button>
    </h2>

    <style id="css">
        text {
            font-weight: 300;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
            font-size: 14px;
        }

        .node rect {
            stroke: #333;
            fill: #fff;
        }

        .edgePath path {
            stroke: #333;
            fill: #333;
            stroke-width: 1.5px;
        }

        .node text {
            pointer-events: none;
        }

        /* This styles the title of the tooltip */
        .tipsy .name {
            font-size: 1.5em;
            font-weight: bold;
            color: #60b1fc;
            margin: 0;
        }

        /* This styles the body of the tooltip */
        .tipsy .description {
            font-size: 1.2em;
        }

        svg {
            border: none;
            outline: none;
            height: 100vh;
            width: 100%;
        }

        h2 {
            position: absolute;
            top: 20px;
            left: 20px;
        }
    </style>

    <svg width="1200" height="720"></svg>

    <script>
        var g = new dagreD3.graphlib.Graph().setGraph({});
        g.graph().ranksep = 200;

        var svg = d3.select("svg");
        var inner = svg.append("g");

        // Set up zoom support
        var zoom = d3.zoom()
            .on("zoom", function () {
                inner.attr("transform", d3.event.transform);
            });
        svg.call(zoom);

        // Function to style the tooltip
        var styleTooltip = function (name, description, inDegree) {
            return "<p class='name'>PMID: " + name + "</p><p class='description'>" + description + "</p><p class='in-degreen'>" + inDegree + "</p>";
        };

        var render = new dagreD3.render();
        render(inner, g);

        function updateSvgSize() {
            const svg = d3.select("svg");
            const windowHeight = window.innerHeight;
            const windowWidth = window.innerWidth;
            svg.attr("height", windowHeight);
            svg.attr("width", windowWidth);
        }

        window.addEventListener("resize", updateSvgSize);
        updateSvgSize();

        async function fetchPubMedData() {
            const pmidInput = document.getElementById("pmidInput").value;
            let pmidList = pmidInput.split(",").map(id => id.trim());

            const maxIterations = 5;
            let prePmidList = [];

            for (let i = 0; i < maxIterations; i++) {
                console.log(`Iteration ${i + 1}:`);
                console.log("PubMed IDs:", pmidList.join(", "));

                await processPubMedData(pmidList);

                const newPmidList = g.nodes()
                    .sort((a, b) => b - a)
                    .slice(0, 30);

                // 孫引きから新たに取得したPubMed IDがなければ繰り返しを終了します
                if (newPmidList === prePmidList) {
                    console.log("No new PubMed IDs found. Stopping iteration.");
                    break;
                };

                pmidList = g.nodes()
                    .sort((a, b) => b - a)
                    .slice(0, 30);

                prePmidList = newPmidList;
            }

            g.nodes().forEach((nodeId) => {
                const inEdges = g.inEdges(nodeId);
                const inDegree = inEdges ? inEdges.length : 0;
                g.node(nodeId).inDegree = inDegree;
            });

            // ノードをin-degreeの多い順にソート
            const sortedNodes = g.nodes().sort((a, b) => g.node(b).inDegree - g.node(a).inDegree);

            // 上位30件以外のノード（ただしpmidは残す）を削除
            for (let i = 0; i < sortedNodes.length; i++) {
                const nodeId = sortedNodes[i];
                if (!pmidList.includes(nodeId) && i >= 15) {
                    g.removeNode(nodeId);
                    g.edges().forEach((edge) => {
                        if (edge.v === nodeId || edge.w === nodeId) {
                            g.removeEdge(edge);
                        }
                    });
                }
            }

            // グラフを再描画
            render(inner, g);

            inner.selectAll("g.node")
                .attr("title", function (v) { return styleTooltip(v, g.node(v).description, g.node(v).inDegree) })
                .each(function (v) { $(this).tipsy({ gravity: "w", opacity: 1, html: true }); })

            var initialScale = 1;
            svg.call(zoom.transform, d3.zoomIdentity.scale(initialScale));
            // svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g.graph().width * initialScale) / 2, (svg.attr("height") - g.graph().height * initialScale) / 2).scale(initialScale));

            svg.attr('height', '100%');
            svg.attr('y', window.innerHeight / 2); // 垂直方向に中央に配置

        }

        async function processPubMedData(pmidList) {
            const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmidList.join(",")}`;

            try {
                const response = await fetch(url);
                const data = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, "text/xml");
                const pubmedArticles = xmlDoc.querySelectorAll("PubmedArticle");

                pubmedArticles.forEach((article) => {
                    const pmid = article.querySelector("PubmedData > ArticleIdList > ArticleId[IdType='pubmed']").textContent;
                    const articleTitle = article.querySelector("MedlineCitation > Article > ArticleTitle").textContent;

                    g.setNode(pmid, {
                        description: articleTitle, style: "fill: #f77"
                    })

                    const referenceElements = article.querySelectorAll("PubmedData > ReferenceList > Reference");

                    if (referenceElements.length > 0) {
                        referenceElements.forEach((referenceElement) => {
                            const pubmedIDElement = referenceElement.querySelector("ArticleIdList > ArticleId[IdType='pubmed']");
                            const referenceCitation = referenceElement.querySelector("Citation").textContent;
                            if (pubmedIDElement) {
                                const pubmedID = pubmedIDElement.textContent;
                                const newNode = {
                                    description: referenceCitation
                                };

                                g.setNode(pubmedID, newNode);
                                g.setEdge(pmid, pubmedID, { label: "" });
                            }
                        });

                    } else {
                        // 引用文が存在しない場合にメッセージを表示
                        console.log(`<p>${pmid} の参考文献は見つかりませんでした。</p>`);
                    }
                });
                console.log("収集成功")

            } catch (error) {
                console.error("データの取得中にエラーが発生しました: " + error);
            }
        }
    </script>
</body>

</html>
